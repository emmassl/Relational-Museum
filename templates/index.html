<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relational Museum</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Inter", sans-serif; background: #FAFAFA; color: #1A1A1A; min-height: 100vh; }
        
        .app-main { display: flex; gap: 1.5rem; padding: 1.5rem; height: 100vh; }
        .viz-section { flex: 1; display: flex; flex-direction: column; gap: 1rem; }
        .controls-row { display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
        
        .search-bar { display: flex; align-items: center; gap: 0.5rem; background: #FFF; border: 1px solid #E0E0E0; border-radius: 6px; padding: 0.625rem 0.875rem; max-width: 400px; }
        .search-bar input { flex: 1; border: none; font-size: 0.875rem; outline: none; }
        
        .filter-controls { display: flex; gap: 0.5rem; }
        .filter-btn { background: #FFF; border: 2px solid; padding: 0.5rem 0.875rem; border-radius: 6px; cursor: pointer; font-size: 0.8125rem; font-weight: 500; transition: all 150ms; }
        .filter-btn:hover { opacity: 0.8; }
        .cultural-btn { border-color: #E67E22; color: #E67E22; }
        .cultural-btn.active { background: #E67E22; color: #FFF; }
        .form-btn { border-color: #27AE60; color: #27AE60; }
        .form-btn.active { background: #27AE60; color: #FFF; }
        .thematic-btn { border-color: #8E44AD; color: #8E44AD; }
        .thematic-btn.active { background: #8E44AD; color: #FFF; }
        .spatial-btn { border-color: #3498DB; color: #3498DB; }
        .spatial-btn.active { background: #3498DB; color: #FFF; }
        
        .walk-btn { background: #1A1A1A; border: 1px solid #1A1A1A; color: #FFF; padding: 0.5rem 0.875rem; border-radius: 6px; cursor: pointer; font-size: 0.8125rem; font-weight: 500; transition: all 150ms; display: flex; align-items: center; gap: 0.5rem; }
        .walk-btn:hover { background: #333; }
        .walk-btn.active { background: #666; }
        
        .pagination-controls { display: flex; gap: 0.5rem; align-items: center; }
        .pagination-info, .page-btn { background: #FFF; border: 1px solid #E0E0E0; padding: 0.5rem 0.875rem; border-radius: 6px; font-size: 0.8125rem; }
        .page-btn { cursor: pointer; transition: all 150ms; }
        .page-btn:hover:not(:disabled) { background: #1A1A1A; color: #FFF; }
        .page-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .visualization-container { flex: 1; background: #FFF; border: 1px solid #E0E0E0; border-radius: 8px; position: relative; }
        #viz { width: 100%; height: 100%; }
        
        .zoom-controls { position: absolute; top: 1rem; right: 1rem; display: flex; flex-direction: column; gap: 0.25rem; background: #FFF; border: 1px solid #E0E0E0; border-radius: 6px; padding: 0.25rem; }
        .zoom-btn { background: #FFF; border: none; width: 32px; height: 32px; border-radius: 4px; cursor: pointer; font-size: 1.125rem; transition: all 150ms; }
        .zoom-btn:hover { background: #F5F5F5; }
        
        .object-detail { width: 360px; background: #FFF; border: 1px solid #E0E0E0; border-radius: 8px; padding: 1.5rem; overflow-y: auto; display: none; position: relative; }
        .object-detail.active { display: block; }
        .object-detail h2 { font-size: 1.25rem; margin-bottom: 0.75rem; font-weight: 600; }
        .object-detail .meta { font-size: 0.875rem; color: #666; margin-bottom: 1.25rem; line-height: 1.6; }
        .object-detail img { width: 100%; border-radius: 6px; margin-bottom: 1rem; border: 1px solid #E0E0E0; }

        .node-image { cursor: pointer; object-fit: cover; border-radius: 50%; }
        .node-image.selected { stroke: #1A1A1A; stroke-width: 4px; filter: drop-shadow(0 0 8px rgba(26, 26, 26, 0.5)); }
        .node-image.walking { stroke: #666; stroke-width: 3px; }
        
        .link { stroke: #CCCCCC; stroke-width: 1px; opacity: 0.6; }
        .link.cultural { stroke: #E67E22; stroke-width: 1.5px; }
        .link.form { stroke: #27AE60; stroke-width: 1.5px; }
        .link.thematic { stroke: #8E44AD; stroke-width: 1.5px; }
        .link.spatial { stroke: #3498DB; stroke-width: 1.5px; }
        
        .node-fallback { fill: #F5F5F5; stroke: #E0E0E0; stroke-width: 2px; }
        .node-fallback-text { fill: #666; font-size: 16px; font-weight: 500; }
    </style>
</head>
<body>
    <div class="app-main">
        <div class="viz-section">
            <div class="controls-row">
                <div class="search-bar">
                    <svg viewBox="0 0 24 24" width="18" height="18">
                        <circle cx="10" cy="10" r="6" fill="none" stroke="currentColor" stroke-width="2"/>
                        <line x1="14.5" y1="14.5" x2="21" y2="21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <input type="text" id="searchInput" placeholder="Search collection...">
                    <button id="clearSearch" style="background: none; border: none; cursor: pointer; display: none;">
                        <svg viewBox="0 0 24 24" width="16" height="16">
                            <line x1="6" y1="6" x2="18" y2="18" stroke="#666" stroke-width="2" stroke-linecap="round"/>
                            <line x1="18" y1="6" x2="6" y2="18" stroke="#666" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                </div>
                
                <button class="walk-btn" id="walkBtn">
                    <svg viewBox="0 0 24 24" width="16" height="16">
                        <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/>
                        <polygon points="10,8 10,16 16,12" fill="currentColor"/>
                    </svg>
                    <span>Collections Walk</span>
                </button>
            </div>

            <div class="controls-row">
                <div class="filter-controls">
                    <button class="filter-btn active cultural-btn" data-filter="cultural">Cultural</button>
                    <button class="filter-btn active form-btn" data-filter="form">Form</button>
                    <button class="filter-btn active thematic-btn" data-filter="thematic">Thematic</button>
                    <button class="filter-btn active spatial-btn" data-filter="spatial">Spatial</button>
                </div>

                <div class="pagination-controls">
                    <div class="pagination-info" id="paginationInfo">Loading...</div>
                    <button class="page-btn" id="prevPage">←</button>
                    <button class="page-btn" id="nextPage">→</button>
                </div>
            </div>

            <div class="visualization-container">
                <svg id="viz"></svg>
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoomIn">+</button>
                    <button class="zoom-btn" id="zoomReset">○</button>
                    <button class="zoom-btn" id="zoomOut">−</button>
                </div>
            </div>
        </div>

        <div class="object-detail" id="objectDetail">
            <button id="closeDetail" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; cursor: pointer; padding: 4px;">
                <svg viewBox="0 0 24 24" width="20" height="20">
                    <line x1="6" y1="6" x2="18" y2="18" stroke="#666" stroke-width="2" stroke-linecap="round"/>
                    <line x1="18" y1="6" x2="6" y2="18" stroke="#666" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <h2 id="detailTitle"></h2>
            <div class="meta" id="detailMeta"></div>
            <div id="detailDescription"></div>
        </div>

        <!-- Starting JS Functionality & Animation -->
    <script>
        let allData = [];
        let filteredData = [];
        let currentFilters = { cultural: true, form: true, thematic: true, spatial: true };
        let currentPage = 0;
        let simulation = null;
        let zoomBehavior = null;
        
        let walkModeActive = false;
        let walkInterval = null;
        let currentWalkIndex = 0;
        
        const ITEMS_PER_PAGE = 50;

        function stripHtml(html) {
            if (!html) return '';
            const tmp = document.createElement('div');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }

        function getConnectionCount(obj) {
            if (!obj.relations) return 0;
            return Object.values(obj.relations).reduce((sum, arr) => sum + arr.length, 0);
        }

        // Load data
        fetch('/api/collection')
            .then(response => response.json())
            .then(data => {
                allData = data;
                allData.forEach(obj => obj.connectionCount = getConnectionCount(obj));
                allData.sort((a, b) => b.connectionCount - a.connectionCount);
                filteredData = [...allData];
                updatePaginationInfo();
                renderVisualization();
            });

        // Search with word-boundary matching
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.trim();
            document.getElementById('clearSearch').style.display = query ? 'block' : 'none';
            if (!query) {
                filteredData = [...allData];
            } else {
                // Ex: matches 'ring', 'rings', but not 'earring'
                // (?<![a-zA-Z]) = not preceded by letter, (?![a-zA-Z]) = not followed by letter (except 's')
                const pattern = new RegExp('(?<![a-zA-Z])' + query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + 's?(?![a-zA-Z])', 'i');
                filteredData = allData.filter(obj => 
                    pattern.test([
                        obj.title,
                        obj.form,
                        obj.description,
                        obj.cultures,
                        obj.places,
                        obj.themes,
                        obj.names
                    ].flat().join(' '))
                );
            }
            currentPage = 0;
            updatePaginationInfo();
            renderVisualization();
        });

        // Close detail panel
        document.getElementById('closeDetail').addEventListener('click', () => {
            document.getElementById('objectDetail').classList.remove('active');
            d3.selectAll('.node-image').classed('selected', false);
        });

        // Clear search button
        document.getElementById('clearSearch').addEventListener('click', () => {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearch').style.display = 'none';
            filteredData = [...allData];
            currentPage = 0;
            updatePaginationInfo();
            renderVisualization();
        });

        // Filters
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                currentFilters[btn.dataset.filter] = !currentFilters[btn.dataset.filter];
                btn.classList.toggle('active');
                renderVisualization();
            });
        });

        // Pagination
        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 0) {
                currentPage--;
                updatePaginationInfo();
                renderVisualization();
            }
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            const maxPage = Math.max(0, Math.ceil(filteredData.length / ITEMS_PER_PAGE) - 1);
            if (currentPage < maxPage) {
                currentPage++;
                updatePaginationInfo();
                renderVisualization();
            }
        });

        // Collections Walk Mode
        document.getElementById('walkBtn').addEventListener('click', () => {
            walkModeActive = !walkModeActive;
            const btn = document.getElementById('walkBtn');
            
            if (walkModeActive) {
                btn.classList.add('active');
                btn.querySelector('span').textContent = 'Stop Walk';
                startWalk();
            } else {
                btn.classList.remove('active');
                btn.querySelector('span').textContent = 'Collections Walk';
                stopWalk();
            }
        });

        function startWalk() {
            const start = currentPage * ITEMS_PER_PAGE;
            const pageData = filteredData.slice(start, start + ITEMS_PER_PAGE);
            if (pageData.length === 0) return;
            
            currentWalkIndex = 0;
            visitNextObject(pageData);
            
            walkInterval = setInterval(() => {
                currentWalkIndex = (currentWalkIndex + 1) % pageData.length;
                visitNextObject(pageData);
            }, 8000);
        }

        function stopWalk() {
            if (walkInterval) {
                clearInterval(walkInterval);
                walkInterval = null;
            }
            d3.selectAll('.node-image').classed('walking', false);
        }

        function visitNextObject(pageData) {
            const obj = pageData[currentWalkIndex];
            
            d3.selectAll('.node-image').classed('selected', false);
            d3.selectAll('.node-image').classed('walking', false);
            
            d3.selectAll('.node-image')
                .filter(d => d.id === obj.id)
                .classed('walking', true);
            
            showObjectDetail(obj);
            
            // Zoom to object
            const node = d3.selectAll('g').filter(d => d && d.id === obj.id);
            if (!node.empty()) {
                const nodeData = node.datum();
                if (nodeData && nodeData.x && nodeData.y) {
                    const svg = d3.select('#viz');
                    const container = document.getElementById('viz').parentElement;
                    const width = container.clientWidth;
                    const height = container.clientHeight;
                    
                    const scale = 1.5;
                    const x = width / 2 - nodeData.x * scale;
                    const y = height / 2 - nodeData.y * scale;
                    
                    svg.transition()
                        .duration(800)
                        .call(zoomBehavior.transform, d3.zoomIdentity.translate(x, y).scale(scale));
                }
            }
        }

        function updatePaginationInfo() {
            const total = filteredData.length;
            const start = currentPage * ITEMS_PER_PAGE + 1;
            const end = Math.min((currentPage + 1) * ITEMS_PER_PAGE, total);
            document.getElementById('paginationInfo').textContent = total > 0 ? `${start}-${end} of ${total}` : '0 objects';
            document.getElementById('prevPage').disabled = currentPage === 0;
            document.getElementById('nextPage').disabled = end >= total;
        }

        function renderVisualization() {
            const container = document.getElementById('viz');
            container.innerHTML = '';

            const width = container.parentElement.clientWidth;
            const height = container.parentElement.clientHeight;

            const start = currentPage * ITEMS_PER_PAGE;
            const pageData = filteredData.slice(start, start + ITEMS_PER_PAGE);

            const nodes = pageData.map(d => ({ id: d.id, ...d }));
            const links = [];
            const linkSet = new Set();

            pageData.forEach(obj => {
                ['cultural', 'form', 'thematic', 'spatial'].forEach(type => {
                    if (currentFilters[type] && obj.relations && obj.relations[type]) {
                        obj.relations[type].forEach(targetId => {
                            if (pageData.find(o => o.id === targetId)) {
                                const key = [obj.id, targetId].sort().join('-');
                                if (!linkSet.has(key)) {
                                    links.push({ source: obj.id, target: targetId, type: type });
                                    linkSet.add(key);
                                }
                            }
                        });
                    }
                });
            });

            const svg = d3.select('#viz').attr('width', width).attr('height', height);
            const g = svg.append('g');

            zoomBehavior = d3.zoom()
                .scaleExtent([0.5, 3])
                .on('zoom', (event) => g.attr('transform', event.transform));

            svg.call(zoomBehavior);

            document.getElementById('zoomIn').onclick = () => svg.transition().call(zoomBehavior.scaleBy, 1.3);
            document.getElementById('zoomOut').onclick = () => svg.transition().call(zoomBehavior.scaleBy, 0.7);
            document.getElementById('zoomReset').onclick = () => svg.transition().call(zoomBehavior.transform, d3.zoomIdentity);

            simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(80))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(30))
                .force('x', d3.forceX(width / 2).strength(0.1))
                .force('y', d3.forceY(height / 2).strength(0.1));

            g.append('g')
                .selectAll('line')
                .data(links)
                .enter()
                .append('line')
                .attr('class', d => `link ${d.type}`);

            const nodeGroup = g.append('g')
                .selectAll('g')
                .data(nodes)
                .enter()
                .append('g')
                .call(d3.drag()
                    .on('start', (event, d) => {
                        if (!event.active) simulation.alphaTarget(0.3).restart();
                        d.fx = d.x;
                        d.fy = d.y;
                    })
                    .on('drag', (event, d) => {
                        d.fx = event.x;
                        d.fy = event.y;
                    })
                    .on('end', (event, d) => {
                        if (!event.active) simulation.alphaTarget(0);
                        d.fx = null;
                        d.fy = null;
                    }))
                .on('click', (event, d) => {
                    d3.selectAll('.node-image').classed('selected', false);
                    d3.select(event.currentTarget).select('.node-image').classed('selected', true);
                    showObjectDetail(d);
                });

            nodeGroup.append('clipPath')
                .attr('id', d => `clip-${d.id.replace(/[^a-zA-Z0-9]/g, '')}`)
                .append('circle')
                .attr('r', 28);
            
            // Adding images to nodes
            nodeGroup.append('image')
                .attr('class', 'node-image')
                .attr('xlink:href', d => d.image_url || '')
                .attr('clip-path', d => `url(#clip-${d.id.replace(/[^a-zA-Z0-9]/g, '')})`)
                .attr('x', -28)
                .attr('y', -28)
                .attr('width', 56)
                .attr('height', 56)
                // If image not found (even though DB only stores objects with images, good practice incase image link is broken):
                .on('error', function(event, d) {
                    const parent = d3.select(this.parentNode);
                    parent.append('circle').attr('class', 'node-fallback').attr('r', 28);
                    parent.append('text')
                        .attr('class', 'node-fallback-text')
                        .attr('text-anchor', 'middle')
                        .attr('dy', '.35em')
                        .text(d.title.charAt(0).toUpperCase());
                    d3.select(this).remove();
                });

            simulation.on('tick', () => {
                g.selectAll('line')
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                nodeGroup.attr('transform', d => `translate(${d.x},${d.y})`);
            });
        }

        function showObjectDetail(obj) {
            const cleanTitle = stripHtml(obj.title);
            const cleanDescription = stripHtml(obj.description);
            
            document.getElementById('detailTitle').textContent = cleanTitle;
            
            let metaHtml = '';
            if (obj.image_url) metaHtml += `<img src="${obj.image_url}" alt="${cleanTitle}">`;
            if (obj.museum_name) metaHtml += `<p><strong>Collection:</strong> ${obj.museum_name}</p>`;
            if (obj.cultures?.length) metaHtml += `<p><strong>Culture(s):</strong> ${obj.cultures.join(', ')}</p>`;
            if (obj.places?.length) metaHtml += `<p><strong>Places:</strong> ${obj.places.join(', ')}</p>`;
            metaHtml += `<p><strong>Date:</strong> ${obj.date}</p>`;
            metaHtml += `<p><strong>Form:</strong> ${obj.form}</p>`;
            if (obj.themes?.length) metaHtml += `<p><strong>Themes:</strong> ${obj.themes.slice(0, 5).join(', ')}</p>`;
            if (obj.names?.length) metaHtml += `<p><strong>People:</strong> ${obj.names.join(', ')}</p>`;
            
            document.getElementById('detailMeta').innerHTML = metaHtml;
            document.getElementById('detailDescription').textContent = cleanDescription;
            document.getElementById('objectDetail').classList.add('active');
        }
    </script>
</body>
</html>